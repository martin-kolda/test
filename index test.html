<!doctype html>
<html data-theme="max">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prototype prototype</title>

  <!-- CDN / dependecies -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/2c7f1c6cae.js" crossorigin="anonymous"></script>   
  <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="./theme/max-tokens.css"> 
  <script> // cannot be loaded by classic link
    fetch('./theme/tw-mapping.css', { cache: 'no-store' }).then(r => r.text()).then(css => {const s = document.createElement('style');s.type = 'text/tailwindcss';s.textContent = css;document.head.appendChild(s);});
  </script>
  <link rel="stylesheet" href="./theme/max.css" type="text/css">
  <script defer src="https://unpkg.com/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>  
  <style>
  [x-cloak]{display:none}
  @keyframes slideInLeft  { from { transform: translateX(-6%); opacity: .01 } to { transform: translateX(0); opacity: 1 } }
  @keyframes slideInRight { from { transform: translateX( 6%); opacity: .01 } to { transform: translateX(0); opacity: 1 } }
  .slide-in-left  { animation: slideInLeft  .18s ease-out; }
  .slide-in-right { animation: slideInRight .18s ease-out; }    
  body {
      font-family: 'Figtree', sans-serif;
     
    }
  </style>
</head>

<body class="bg-red-200 border-1 mb-0" x-data="storeApp">


<!-- ROUTE == PRODUCTS -->
<section x-show="is('products')" x-cloak>
<!-- PAGE CONTENT -->  
<h1 class="text-3xl w-11/12 lg:w-10/12 pl-0 md:pl-4 mx-auto">Zdraví a léky</h1>

</section>



  <script>
    document.addEventListener('alpine:init', () => {

      // TOASTS
      Alpine.store('toast', {
    items: [],
    push(text, type = 'success', life = 3000) {
      const id = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)) + Date.now();
      const item = { id, text, type, show: true };
      this.items.push(item);
      // auto-hide after `life` ms
      item._lifeTimer = setTimeout(() => this.hide(id), life);
    },
    hide(id) {
      const t = this.items.find(i => i.id === id);
      if (!t || !t.show) return;
      t.show = false; // triggers leave transition
      // remove after transition finishes (keep in sync with duration-300)
      clearTimeout(t._removeTimer);
      t._removeTimer = setTimeout(() => this.remove(id), 320);
    },
    remove(id) {
      this.items = this.items.filter(t => t.id !== id);
    }
  });
    // PRODUCT DETAIL
    Alpine.data('productDetail', (opts = {}) => ({
      // options / inputs
      id: opts.id ?? null,
      fetchUrl: opts.fetchUrl ?? 'data/product.json',
      initialProduct: opts.product ?? null,
      // botto-bar
      ctaVisible: false,
      _scrollY: 0,
      _scrollThreshold: 1300,   // px from top before CTA can appear
      _scrollJitter: 2,        // ignore tiny scroll jitter
      _onScroll: null,
      // state
      product: { badges: [], reviews: null, description: '' },
      images: [],
      variants: [],
      selectedVariant: null,
      currentImage: 0,
      activeTab: 'desc',

      // lifecycle — Alpine auto-calls init(), so x-init="init()" is NOT needed
     async init() {
        try {
          // Either use provided product or fetch
          this.product = this.initialProduct || await (await fetch(this.fetchUrl)).json();

          this.images = this.product.images || [];
          this.variants = this.product.variants || [];
          this.selectedVariant = this.variants[0] || null;
        } catch (e) {
          console.error('product.json load failed', e);
        }
        // bottom-bar
        this._scrollY = window.scrollY;
        this._onScroll = () => {
        const y = window.scrollY;
        const down = y > this._scrollY + this._scrollJitter;
        const up   = y < this._scrollY - this._scrollJitter;
        this._scrollY = y;

        if (y < this._scrollThreshold) { this.ctaVisible = false; return; }
        if (down) this.ctaVisible = true;
        if (up)   this.ctaVisible = false;
      };
      window.addEventListener('scroll', this._onScroll, { passive: true });
 
      },



      // variants
      selectVariant(id) {
        const v = this.variants.find(x => x.id === id);
        if (v) this.selectedVariant = v;
      },

      // pricing helpers
      basePrice() {
        const p = this.selectedVariant || this.product || {};
        return Number(p.price ?? 0);
      },
      baseDiscounted() {
        const p = this.selectedVariant || this.product || {};
        const d = Number(p.discounted_price ?? 0);
        return d > 0 ? d : null;
      },
      priceOriginal() { return this.basePrice(); },
      priceNow()      { return this.baseDiscounted() ?? this.basePrice(); },
      hasDiscount()   { return this.baseDiscounted() != null && this.baseDiscounted() < this.basePrice(); },
      discountPercent() {
        if (!this.hasDiscount()) return 0;
        return Math.round(100 - (this.baseDiscounted() / this.basePrice()) * 100);
      },
      formatPrice(v) {
        return new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(v);
      },

      // add to cart toast (hook into your existing toast store)
      addToCartClick() {
        const name = this.product?.name || 'Produkt';
        Alpine.store('toast')?.push(`Přidáno do košíku: ${name}`, 'success');
        // If you also want to add to your global cart, call your store method here.
      }
    })); 

    // USER REVIEWS LIS
    Alpine.data('reviewsSection', (opts = {}) => ({
    url: opts.url ?? 'data/reviews.json',
    items: [],
    loading: true,
    error: null,

    async init() {
      try {
        const res = await fetch(this.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        this.items = await res.json();
      } catch (e) {
        console.error('reviews load failed', e);
        this.error = 'Nepodařilo se načíst recenze.';
      } finally {
        this.loading = false;
      }
    },

    count() {
      return Array.isArray(this.items) ? this.items.length : 0;
    },
    average() {
      if (!this.count()) return 0;
      const sum = this.items.reduce((s, r) => s + Number(r.score || 0), 0);
      return +(sum / this.count()).toFixed(1);
    },

    // Build 5 icons for a given score (full/half/empty)
    starsFor(val) {
      const v = Math.max(0, Math.min(5, Math.round(Number(val) * 2) / 2)); // nearest 0.5
      return Array.from({ length: 5 }, (_, i) => {
        const n = i + 1;
        if (v >= n) return 'full';
        if (v >= n - 0.5) return 'half';
        return 'empty';
      });
    }
  })),    
    //BENEFIT PAYMENTS
    Alpine.data('benefitsSection', (opts = {}) => ({
    url: opts.url ?? 'data/benefits.json',
    items: [],
    loading: true,
    error: null,

    async init() {
      try {
        const res = await fetch(this.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        // sort: available first, then name
        this.items = (Array.isArray(data) ? data : [])
          .sort((a,b) => (b.available - a.available) || String(a.name).localeCompare(String(b.name), 'cs'));
      } catch (e) {
        console.error('benefits load failed', e);
        this.error = 'Nepodařilo se načíst seznam benefitních karet.';
      } finally {
        this.loading = false;
      }
    },

    count(){ return this.items.length; }
  })),

    //PRODUCT COMPARISON
    Alpine.data('comparisonSection', (opts = {}) => ({
    url: opts.url ?? 'data/comparison.json',
    id:  opts.id ?? null,

    loading: true,
    error: null,
    items: [],   // products to compare (columns)

    async init() {
      if (!this.id) { this.loading = false; return; }
      await this.load(this.id);
    },

    async load(groupId) {
      this.loading = true; this.error = null;
      try {
        const res = await fetch(this.url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const groups = await res.json();
        const found = Array.isArray(groups) ? groups.find(g => Number(g.id) === Number(groupId)) : null;
        this.items = found?.product_comparison || [];
      } catch (e) {
        console.error('comparison load failed', e);
        this.error = 'Nepodařilo se načíst porovnání.';
      } finally {
        this.loading = false;
      }
    },

    count(){ return this.items.length; },

    priceNow(p){
      const price = Number(p?.price ?? 0);
      const disc  = Number(p?.discounted_price ?? 0);
      // use discounted only if it exists and is lower than regular
      return (disc > 0 && disc < price) ? disc : price;
    },
    priceOriginal(p){ return Number(p?.price ?? 0); },

    unitLabel(p){
      const u = (p?.unit || '').trim();
      return u || 'jedn.';
    },

    pricePerUnit(p){
      const v = Number(p?.volume ?? 0);
      if (!v) return null;
      return this.priceNow(p) / v;
    },

    unitPriceText(p){
      const v = Number(p?.volume ?? 0);
      if (!v) return '—';
      const num = new Intl.NumberFormat('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(this.pricePerUnit(p));
      return `${num} Kč / ${this.unitLabel(p)}`;
    },

    fmtPrice(v){
      return new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(Number(v||0));
    },

    shortDesc(txt, n = 120){
      if (!txt) return '—';
      const t = String(txt).trim();
      return t.length > n ? t.slice(0, n - 1) + '…' : t;
    }
  })),

      // STORE CORE + ROUTER
      Alpine.data('storeApp', () => ({
    // persisted prefs
    locale: Alpine.$persist('cs').as('locale'),

    // state
    products: [],
    categories: [],
    search: '',
    selectedCategory: '',
    sortOrder: '',
    isLoading: true,
    _filterTimer: null,
    page: 1,
    pageSize: 8,
    showCount: 8, // how many items visible on page
    cart: {},

    // router
    route: 'products',
    params: {},

    // ---- SINGLE init ----
    init() {
      // 1) Router first (sync)
      window.addEventListener('hashchange', () => this._onRoute());
      this._onRoute();

      // 2) Watchers (sync)
      const trigger = () => {
        this.page = 1;
        this.showCount = this.pageSize;
        this.scheduleDisplayDelay();
      };
      this.$watch('search', trigger);
      this.$watch('selectedCategory', trigger);
      this.$watch('sortOrder', trigger);

      // keep page in range if results shrink
      this.$watch(() => this.filteredProducts().length, () => {
        this.page = Math.min(this.page, this.totalPages());
      });

      // 3) Kick off async data load (do not await)
      this.loadData();
    },

    // async fetch split out of init
    async loadData() {
      try {
        const res = await fetch('data/products.json');
        this.products = await res.json();
        this.categories = [...new Set(this.products.map(p => p.category))];
      } catch (e) {
        console.error('Failed to load products.json', e);
      } finally {
        this.isLoading = false;
      }
    },

    go(to) {
  location.hash = to.startsWith('#') ? to : ('#' + to.replace(/^#/, ''));
},

// check current route; can accept one name or an array of names
is(nameOrArr) {
  return Array.isArray(nameOrArr)
    ? nameOrArr.includes(this.route)
    : this.route === nameOrArr;
},

_onRoute() {
  // raw like "product/xylomax-0-5/leaflet" or ""
  const raw = (location.hash || '#/products').replace(/^#\/?/, '');
  // split path and optional query (we ignore query for now)
  const [pathPart] = raw.split('?');
  const seg = pathPart.split('/').map(s => decodeURIComponent(s || ''));

  const [path, id, sub] = seg; // sub = optional tab on product

  switch (path) {
    case '':
    case 'products':
      this.route = 'products';
      this.params = {};
      break;

    case 'cart':
      this.route = 'cart';
      this.params = {};
      break;

    case 'product':
      if (id) {
        this.route = 'product';
        // allow deep-linking the tab: /product/:id/:tab
        this.params = { id, tab: sub || 'desc' };
      } else {
        // missing id -> go home
        this.route = 'product';
        this.params = {};
      }
      break;

    default:
      // unknown route -> home
      this.route = 'products';
      this.params = {};
  }
},

    // --- cart helpers ---
    inCart(id) { id = String(id); return Object.prototype.hasOwnProperty.call(this.cart, id); },
    qty(id)    { id = String(id); return this.cart[id]?.qty ?? 0; },

    addToCart(product) {
      const id = String(product.id);
      if (this.inCart(id)) { this.increment(id); return; }
      // force reactivity by replacing object reference
      this.cart = { ...this.cart, [id]: { qty: 1, product } };
      Alpine.store('toast').push(`Přidáno do košíku: ${product.name}`, 'success');
    },
    increment(id) {
      id = String(id);
      if (!this.inCart(id)) return;
      this.cart[id].qty++;
    },
    decrement(id) {
      id = String(id);
      if (!this.inCart(id)) return;
      const next = this.cart[id].qty - 1;
      if (next <= 0) {
        delete this.cart[id];
        this.cart = { ...this.cart };
      } else {
        this.cart[id].qty = next;
      }
    },
    setQty(id, raw) {
      id = String(id);
      let n = parseInt(raw, 10);
      if (!Number.isFinite(n) || n <= 0) {
        delete this.cart[id];
        this.cart = { ...this.cart };
        return;
      }
      this.cart[id].qty = n;
    },

    // --- loader delay ---
    scheduleDisplayDelay() {
      this.isLoading = true;
      clearTimeout(this._filterTimer);
      this._filterTimer = setTimeout(() => { this.isLoading = false; }, 750);
    },

    // --- filtering/sort ---
    filteredProducts() {
      let items = this.products;

      if (this.search) {
        const s = this.search.toLowerCase();
        items = items.filter(p =>
          p.name.toLowerCase().includes(s) ||
          p.description.toLowerCase().includes(s)
        );
      }
      if (this.selectedCategory) {
        items = items.filter(p => p.category === this.selectedCategory);
      }
      if (this.sortOrder === 'asc') {
        items = items.slice().sort((a, b) => (a.price ?? 0) - (b.price ?? 0));
      } else if (this.sortOrder === 'desc') {
        items = items.slice().sort((a, b) => (b.price ?? 0) - (a.price ?? 0));
      }
      return items;
    },

    // --- load-more (page 1 only, +8 each click) ---
    canLoadMoreFirstPage() {
      return this.page === 1 && this.showCount < this.filteredProducts().length;
    },
    loadMore() {
      const total = this.filteredProducts().length;
      this.showCount = Math.min(this.showCount + this.pageSize, total);
    },
    loadMoreLabel() {
      const remaining = this.filteredProducts().length - this.showCount;
      const n = Math.min(this.pageSize, Math.max(0, remaining));
      return n ? `Načíst dalších ${n} produktů` : 'Vše načteno';
    },

    // --- pagination ---
    totalPages() {
      const total = this.filteredProducts().length;
      if (total <= this.showCount) return 1;
      return 1 + Math.ceil((total - this.showCount) / this.pageSize);
    },
    pagedProducts() {
      const items = this.filteredProducts();
      if (this.page === 1) return items.slice(0, this.showCount);
      const start = this.showCount + (this.page - 2) * this.pageSize;
      return items.slice(start, start + this.pageSize);
    },
    pagesToShow() {
      const p = this.page, t = this.totalPages();
      if (t <= 7) return Array.from({ length: t }, (_, i) => i + 1);
      if (p <= 4) return [1, 2, 3, 4, 5, '…', t];
      if (p >= t - 3) return [1, '…', t - 4, t - 3, t - 2, t - 1, t];
      return [1, '…', p - 1, p, p + 1, '…', t];
    },
    rangeLabel() {
      const total = this.filteredProducts().length;
      if (!total) return '0 z 0';
      if (this.page === 1) return `1–${this.showCount} z ${total}`;
      const start = this.showCount + (this.page - 2) * this.pageSize + 1;
      const end = Math.min(this.showCount + (this.page - 1) * this.pageSize, total);
      return `${start}–${end} z ${total}`;
    }
  })),
  // HAMBURGER MENU  
  Alpine.store('menu', {
    // state
    open: false,
    menus: [],
    current: null,     // active menu object
    stack: [],         // for back navigation
    slideDir: 1,       // 1 forward, -1 back (animation)
    viewKey: 0,        // bump to retrigger pane animation
    loading: false,
    error: null,

    async load(url = 'data/menus.json') {
      if (this.menus.length) return;
      this.loading = true; this.error = null;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const raw = await res.json();
        this.menus = this.normalize(raw);
      } catch (e) {
        console.error('menu load failed', e);
        this.error = 'Nepodařilo se načíst menu.';
      } finally {
        this.loading = false;
      }
    },

    // Accepts either my camelCase schema or your snake_case + single-string icon
    normalize(arr){
      const normItem = (it = {}) => {
        const out = { ...it };

        // snake_case -> camelCase
        if (out.link_to_menu_id != null) out.linkMenuId = out.link_to_menu_id;
        if (out.router_link) out.route = out.router_link;
        if (out.row_type) out.rowType = out.row_type;

        // icon: "fa-regular capsules" -> { iconSet:'fa-regular', icon:'capsules' }
        if (!out.iconSet && typeof out.icon === 'string' && out.icon.includes(' ')) {
          const [set, name] = out.icon.split(/\s+/, 2);
          out.iconSet = set;
          out.icon = name;
        }

        return out;
      };

      return (arr || []).map(m => ({
        id: m.id,
        parentId: m.parentId ?? m.parent ?? null,
        name: m.name,
        // some menus have root items, some only sections – handle both
        items: Array.isArray(m.items) ? m.items.map(normItem) : [],
        sections: Array.isArray(m.sections)
          ? m.sections.map(s => ({
              name: s.name ?? null,
              type: s.type ?? null,     // 'language' / 'loyalty' / undefined
              items: Array.isArray(s.items) ? s.items.map(normItem) : []
            }))
          : []
      }));
    },

    // helpers
    byId(id){ return this.menus.find(m => Number(m.id) === Number(id)); },
    canGoBack(){ return this.stack.length > 0 || (this.current && this.current.parentId != null); },

    // open from anywhere; default id by screen (lg desktop -> 2, mobile -> 1)
    async openAt(id = null) {
      await this.load();
      if (id == null) {
        id = window.matchMedia('(min-width: 1024px)').matches ? 2 : 1;
      }
      this.stack = [];
      this.slideDir = 1;
      this.current = this.byId(id) || null;
      this.viewKey++;
      this.open = true;
      document.documentElement.style.overflow = 'hidden'; // lock scroll
    },

    close() {
      this.open = false;
      this.stack = [];
      this.current = null;
      document.documentElement.style.overflow = '';
    },

    goToMenu(id) {
      if (!id) return;
      if (!this.current || Number(this.current.id) !== Number(id)) {
        if (this.current) this.stack.push(this.current.id);
        this.slideDir = 1;
        this.current = this.byId(id) || this.current;
        this.viewKey++;
      }
    },

    back() {
      if (!this.canGoBack()) { this.close(); return; }
      const prevId = this.stack.pop() ?? this.current?.parentId;
      if (prevId != null) {
        this.slideDir = -1;
        this.current = this.byId(prevId) || this.current;
        this.viewKey++;
      }
    },

    // click handlers
    onItemClick(item) {
      if (item.linkMenuId != null) {
        this.goToMenu(item.linkMenuId);
        return;
      }
      if (item.route) {
        location.hash = '#/' + String(item.route).replace(/^#?\/?/, '');
        this.close();
        return;
      }
      // no link/route: no-op
    }
  }),  
  
  // PRODUCT RATING
    Alpine.data('ratingLine', (src = {}) => ({
    avg: Number(src?.average ?? 0),
    count: Number(src?.count ?? 0),

    set(r){ this.avg = Number(r?.average ?? 0); this.count = Number(r?.count ?? 0); },

    // array of 5 slots: 'full' | 'half' | 'empty'
    stars() {
      const v = Math.max(0, Math.min(5, Math.round(this.avg * 2) / 2)); // nearest 0.5
      return Array.from({ length: 5 }, (_, i) => {
        const n = i + 1;
        if (v >= n) return 'full';
        if (v >= n - 0.5) return 'half';
        return 'empty';
      });
    },

    fmtAvg(){ return (isFinite(this.avg) ? this.avg : 0).toFixed(1); }
  })),

      // CATEGORIES LIST
      Alpine.data('categoriesList', () => ({
      categories: [],
      fallback: './images/placeholder.png',

      async init() {
        // adjust path if needed
        const res = await fetch('./data/categories.json');
        this.categories = await res.json();
      },

      imageUrl(cat) {
        const base = (cat.image || '').trim();
        const withSlug = base.endsWith('/') ? `${base}${this.slug(cat.name)}.webp` : base;
        return base ? withSlug : this.fallback;
      },

      slug(str) {
        return str
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // remove diacritics
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      },

      productsLabel(n) {
        // Czech pluralization-ish
        if (n === 1) return '1 produkt';
        if (n >= 2 && n <= 4) return `${n} produkty`;
        return `${n} produktů`;
      },
    }))
    })
  </script>


</body>
</html>
